dist: bionic
language: python
services:
  - docker
python:
  - "3.7"
before_install:
  - sudo apt-get update
  - pip install pycodestyle
  - pip install pytest-cov
  - pip install python-coveralls
  - pip install coverage
  - mkdir -p /opt/mycroft/skills/homeassistant.mycroftai
  - cp -R $TRAVIS_BUILD_DIR/* /opt/mycroft/skills/homeassistant.mycroftai
  - docker pull homeassistant/home-assistant:0.114.3
  - docker run -d -p 127.0.0.1:8123:8123 --name="home-assistant" -v $TRAVIS_BUILD_DIR/test/travis-ci/HA/:/config -v /etc/localtime:/etc/localtime:ro homeassistant/home-assistant:0.114.3
  - travis_wait 3 sleep 2m
  - pip install homeassistant-cli
  - export HASS_SERVER=http://127.0.0.1:8123
  - export HASS_TOKEN='eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJmMzI5NmEzYTA0ZDc0NTI3OGUzMDIzN2I5MDlmYmM5MSIsImlhdCI6MTU5ODczMzU5MywiZXhwIjoxOTE0MDkzNTkzfQ.HEGTdkF5tt473J3WktjUIb71x06tZwcZUjp070QzLec'
  - source <(hass-cli completion bash)
  - hass-cli info
  - hass-cli state list
  - cd /opt
  - deactivate
  - git clone https://github.com/MycroftAI/mycroft-core.git
  - cd mycroft-core
  - cp $TRAVIS_BUILD_DIR/test/travis-ci/Mycroft/dev_setup.sh /opt/mycroft-core/
  - chmod +x dev_setup.sh
  - unset VIRTUAL_ENV
  - ./dev_setup.sh --allow-root --travis -sm
  - source /opt/mycroft-core/.venv/bin/activate
  - /opt/mycroft-core/bin/mycroft-pip install -r $TRAVIS_BUILD_DIR/requirements.txt
  - cp $TRAVIS_BUILD_DIR/test/travis-ci/Mycroft/settingsmeta.yaml /opt/mycroft/skills/homeassistant.mycroftai/
  - cp $TRAVIS_BUILD_DIR/test/travis-ci/Mycroft/settings.json /opt/mycroft/skills/homeassistant.mycroftai/
  - /opt/mycroft-core/bin/mycroft-start all
  - travis_wait 6 sleep 4m
  - cd $TRAVIS_BUILD_DIR/
script:
  - echo "Coding style check"
  - pycodestyle --max-line-length=100 __init__.py
  - pycodestyle --max-line-length=100 ha_client.py
  - echo "VKtest"
  - /opt/mycroft-core/bin/mycroft-skill-testrunner vktest clear
  - coverage run -m test.integrationtests.voight_kampff -t homeassistant.mycroftai --stop
after_success:
  - bash <(curl -s https://codecov.io/bash)